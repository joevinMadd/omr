<!-- templates/camera.html -->
{% extends "base.html" %}

{% block title %}Capture Photo{% endblock %}

{% block header %}
    Capture and Save Photo
{% endblock %}

{% block content %}
    <!-- Form to enter folder name and capture image -->
    <form id="photoForm">
        <label for="folderName">Enter Folder Name:</label>
        <input type="text" id="folderName" name="folderName" required><br><br>

        <!-- Input to open the camera and capture a photo -->
        <input type="file" id="capturePhoto" accept="image/*" capture="environment" style="display:none;" />

        <!-- Button to open the camera -->
        <button type="button" id="getPhotoBtn">Get Photo</button><br><br>

        <!-- Display captured image in a preview canvas -->
        <canvas id="canvas" width="240" height="320" style="border: 1px solid black;"></canvas><br><br>

        <!-- Button to upload the captured photo -->
        <button type="submit">Save Photo</button>
    </form>

    <!-- Display chart for saved photos -->
    <div id="photo-chart">
        <h2>Saved Photos by Folder</h2>
        <table id="photoTable" border="1" style="width:100%; text-align: left;">
            <thead>
                <tr>
                    <th>Folder Name</th>
                    <th>Photo Filenames</th>
                </tr>
            </thead>
            <tbody>
                <!-- Folder names and photo filenames will be added here -->
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const getPhotoBtn = document.getElementById('getPhotoBtn');
        const capturePhoto = document.getElementById('capturePhoto');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const photoForm = document.getElementById('photoForm');
        let originalImageData;

        // When the "Get Photo" button is clicked, open the camera input
        getPhotoBtn.addEventListener('click', () => {
            capturePhoto.click();
        });

        // Handle the photo capture from the device camera
        capturePhoto.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Draw the captured image on the canvas at fixed 240x320 dimensions
                        context.clearRect(0, 0, canvas.width, canvas.height);
                        context.drawImage(img, 0, 0, canvas.width, canvas.height);

                        // Save the image at its original resolution (without resizing)
                        originalImageData = e.target.result;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle form submission to save the photo
        photoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const folderName = document.getElementById('folderName').value;

            // Send the original captured image and folder name to the backend
            const response = await fetch('/save-photo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    folderName: folderName,
                    image: originalImageData
                })
            });

            if (response.ok) {
                alert('Photo saved successfully!');
                loadSavedPhotos();
            } else {
                alert('Error saving photo.');
            }
        });

        // Function to load all saved photos and generate the table
        async function loadSavedPhotos() {
            const response = await fetch(`/photos`);
            const folders = await response.json();

            const tableBody = document.querySelector('#photoTable tbody');
            tableBody.innerHTML = ''; // Clear the table body

            // Iterate over folders and generate the chart
            for (const [folderName, photos] of Object.entries(folders)) {
                // Create a new row
                const row = document.createElement('tr');

                // Create folder name cell
                const folderCell = document.createElement('td');
                folderCell.textContent = folderName;
                row.appendChild(folderCell);

                // Create photos filenames cell
                const photosCell = document.createElement('td');
                const fileList = document.createElement('ul');
                photos.forEach(photo => {
                    const fileItem = document.createElement('li');
                    fileItem.textContent = photo;
                    fileList.appendChild(fileItem);
                });
                photosCell.appendChild(fileList);
                row.appendChild(photosCell);

                // Append the row to the table body
                tableBody.appendChild(row);
            }
        }

        // Load the saved photos initially when the page loads
        window.onload = loadSavedPhotos;
    </script>
{% endblock %}
