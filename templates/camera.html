<!-- templates/camera.html -->
{% extends "base.html" %}

{% block title %}Capture Multiple Photos{% endblock %}

{% block header %}
    Capture and Save Multiple Photos
{% endblock %}

{% block content %}
    <!-- Form to enter folder name and capture multiple images -->
    <form id="photoForm">
        <label for="folderName">Enter Folder Name:</label>
        <input type="text" id="folderName" name="folderName" required><br><br>

        <!-- Input to open the camera and capture multiple photos -->
        <input type="file" id="capturePhoto" accept="image/*" capture="environment" multiple style="display:none;" />

        <!-- Button to open the camera -->
        <button type="button" id="getPhotoBtn">Get Photos</button><br><br>

        <!-- Display captured images in preview canvases -->
        <div id="canvasContainer" style="display: flex; gap: 10px;"></div><br><br>

        <!-- Button to upload the captured photos -->
        <button type="submit">Save Photos</button>
    </form>

    <!-- Display chart for saved photos -->
    <div id="photo-chart">
        <h2>Saved Photos by Folder</h2>
        <table id="photoTable" border="1" style="width:100%; text-align: left;">
            <thead>
                <tr>
                    <th>Folder Name</th>
                    <th>Photo Filenames</th>
                </tr>
            </thead>
            <tbody>
                <!-- Folder names and photo filenames will be added here -->
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const getPhotoBtn = document.getElementById('getPhotoBtn');
        const capturePhoto = document.getElementById('capturePhoto');
        const canvasContainer = document.getElementById('canvasContainer');
        const photoForm = document.getElementById('photoForm');
        let capturedImages = [];

        // When the "Get Photos" button is clicked, open the camera input
        getPhotoBtn.addEventListener('click', () => {
            capturePhoto.click();
        });

        // Handle multiple photo captures from the device camera
        capturePhoto.addEventListener('change', (event) => {
            const files = event.target.files;
            capturedImages = [];  // Clear previously captured images
            canvasContainer.innerHTML = '';  // Clear previous canvas elements

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // Create a new canvas for each image
                        const canvas = document.createElement('canvas');
                        canvas.width = 240;
                        canvas.height = 320;
                        const context = canvas.getContext('2d');

                        // Draw the captured image on the canvas at fixed 240x320 dimensions
                        context.drawImage(img, 0, 0, canvas.width, canvas.height);

                        // Append the canvas to the container
                        canvasContainer.appendChild(canvas);

                        // Save the image data at its original resolution
                        capturedImages.push(e.target.result);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        });

        // Handle form submission to save multiple photos
        photoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const folderName = document.getElementById('folderName').value;

            // Send all captured images and folder name to the backend
            const response = await fetch('/save-photos', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    folderName: folderName,
                    images: capturedImages
                })
            });

            if (response.ok) {
                alert('Photos saved successfully!');
                loadSavedPhotos();
            } else {
                alert('Error saving photos.');
            }
        });

        // Function to load all saved photos and generate the table
        async function loadSavedPhotos() {
            const response = await fetch(`/photos`);
            const folders = await response.json();

            const tableBody = document.querySelector('#photoTable tbody');
            tableBody.innerHTML = ''; // Clear the table body

            // Iterate over folders and generate the chart
            for (const [folderName, photos] of Object.entries(folders)) {
                const row = document.createElement('tr');

                // Create folder name cell
                const folderCell = document.createElement('td');
                folderCell.textContent = folderName;
                row.appendChild(folderCell);

                // Create photos filenames cell
                const photosCell = document.createElement('td');
                const fileList = document.createElement('ul');
                photos.forEach(photo => {
                    const fileItem = document.createElement('li');
                    fileItem.textContent = photo;
                    fileList.appendChild(fileItem);
                });
                photosCell.appendChild(fileList);
                row.appendChild(photosCell);

                tableBody.appendChild(row);
            }
        }

        // Load the saved photos initially when the page loads
        window.onload = loadSavedPhotos;
    </script>
{% endblock %}
